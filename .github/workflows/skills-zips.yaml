name: Skill Packages

on:
  workflow_dispatch:
    inputs:
      skills:
        description: 'Space-separated skill names to package (empty = auto-detect changed, on tags = all)'
        required: false
        default: ''
      publish_release:
        description: 'Publish GitHub Release from this run'
        required: false
        type: boolean
        default: false
      release_tag:
        description: 'Release tag to publish (required when publish_release=true), e.g. skills-v2026.02.17'
        required: false
        default: ''
  push:
    branches:
      - main
    tags:
      - 'skills-v*'
    paths:
      - 'altinity-expert-clickhouse/skills/**'
  pull_request:
    branches:
      - main
    paths:
      - 'altinity-expert-clickhouse/skills/**'

jobs:
  build-skill-zips:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Select skills to package
        id: changes
        shell: bash
        run: |
          set -euo pipefail
          list_all_skills() {
            find altinity-expert-clickhouse/skills -mindepth 1 -maxdepth 1 -type d -name 'altinity-*' \
              -exec sh -c 'for d; do [ -f "$d/SKILL.md" ] && basename "$d"; done' sh {} + | sort -u
          }

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            INPUT_SKILLS="${{ github.event.inputs.skills }}"
            PUBLISH_RELEASE="${{ github.event.inputs.publish_release }}"
            if [ -n "$INPUT_SKILLS" ]; then
              printf '%s\n' "$INPUT_SKILLS" | tr ' ' '\n' | awk 'NF' | sort -u > /tmp/skills.txt
            elif [ "$PUBLISH_RELEASE" = "true" ]; then
              list_all_skills > /tmp/skills.txt
            elif [[ "${GITHUB_REF}" == refs/tags/skills-v* ]]; then
              list_all_skills > /tmp/skills.txt
            else
              BASE="$(git merge-base origin/main HEAD || true)"
              HEAD="${{ github.sha }}"
              if [ -n "$BASE" ]; then
                git diff --name-only "$BASE" "$HEAD" | awk -F/ '/^altinity-expert-clickhouse\/skills\//{print $3}' | sort -u > /tmp/skills.txt
              else
                list_all_skills > /tmp/skills.txt
              fi
            fi
          elif [[ "${GITHUB_REF}" == refs/tags/skills-v* ]]; then
            list_all_skills > /tmp/skills.txt
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE="${{ github.event.pull_request.base.sha }}"
            HEAD="${{ github.event.pull_request.head.sha }}"
            git diff --name-only "$BASE" "$HEAD" | awk -F/ '/^altinity-expert-clickhouse\/skills\//{print $3}' | sort -u > /tmp/skills.txt
          else
            BEFORE="${{ github.event.before }}"
            SHA="${{ github.sha }}"
            git diff --name-only "$BEFORE" "$SHA" | awk -F/ '/^altinity-expert-clickhouse\/skills\//{print $3}' | sort -u > /tmp/skills.txt
          fi

          # Keep only existing skills (deleted skills are skipped for packaging).
          awk 'NF' /tmp/skills.txt | while read -r skill; do
            [ -f "altinity-expert-clickhouse/skills/$skill/SKILL.md" ] && echo "$skill"
          done | sort -u > /tmp/skills-final.txt

          skills="$(paste -sd' ' /tmp/skills-final.txt || true)"
          echo "skills=$skills" >> "$GITHUB_OUTPUT"
          echo "Selected skills: ${skills:-<none>}"

      - name: Build skill zips
        if: steps.changes.outputs.skills != ''
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          for skill in ${{ steps.changes.outputs.skills }}; do
            dir="altinity-expert-clickhouse/skills/$skill"
            zip_path="dist/${skill}.zip"
            echo "Packaging $skill..."
            (cd "$dir" && zip -r "$GITHUB_WORKSPACE/$zip_path" . -x "*.DS_Store" -x "*__MACOSX*" -x "*.git*" -x ".system/*")
          done

      - name: Upload build artifact
        if: steps.changes.outputs.skills != ''
        uses: actions/upload-artifact@v4
        with:
          name: skill-zips
          path: dist/*.zip
          if-no-files-found: error

  publish-github-release:
    runs-on: ubuntu-latest
    needs: build-skill-zips
    if: startsWith(github.ref, 'refs/tags/skills-v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_release == 'true')
    permissions:
      contents: write
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: skill-zips
          path: dist

      - name: Resolve release tag
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_REF}" == refs/tags/skills-v* ]]; then
            tag="${GITHUB_REF#refs/tags/}"
          else
            tag="${{ github.event.inputs.release_tag }}"
          fi

          if [[ -z "$tag" ]]; then
            echo "release_tag is required for manual publish runs." >&2
            exit 1
          fi
          if [[ "$tag" != skills-v* ]]; then
            echo "release_tag must start with skills-v, got: $tag" >&2
            exit 1
          fi

          echo "tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Render release notes from template
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ steps.meta.outputs.tag }}"
          sed "s/{{TAG}}/${tag}/g" .github/release-notes-skills.md > /tmp/release-notes.md

      - name: Publish GitHub release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          body_path: /tmp/release-notes.md
          files: dist/*.zip
